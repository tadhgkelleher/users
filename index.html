<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Healing Prototype</title>
    <script src="/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-family: Arial, sans-serif;
        }
        #breathingButton {
            display: none;
            padding: 10px 20px;
            font-size: 16px;
        }
        button, input {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <!-- A-Frame Scene -->
    <a-scene>
        <a-sphere id="breathingSphere" position="0 1.25 -5" radius="1.25" color="red"></a-sphere>
        <a-sky color="#87CEEB"></a-sky> <!-- Light blue sky for calming effect -->
    </a-scene>

    <!-- User Interface -->
    <div id="ui">
        <label for="painLevel">Pain Level (1-10): </label>
        <input type="range" id="painLevel" min="1" max="10" value="5">
        <br>
        <button id="startButton">Start</button>
        <button id="breathingButton">Click with each inhalation</button>
        <p id="instructions">Set your pain level and click Start. Then, click the button when the sphere starts expanding (every 10 seconds).</p>
        <p id="counterDisplay">Matches: 0</p>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // Constants and Variables
        const period = 10; // Breathing cycle in seconds (10s = 6 breaths per minute)
        let windowSize = 1; // Timing window in seconds, adjusted by pain level
        let startTime; // Time when the experience starts
        let counter = 0; // Consecutive matches
        let isStarted = false; // State of the experience

        // DOM Elements
        const painLevelInput = document.getElementById('painLevel');
        const startButton = document.getElementById('startButton');
        const breathingButton = document.getElementById('breathingButton');
        const counterDisplay = document.getElementById('counterDisplay');
        const sphere = document.querySelector('#breathingSphere');

        // Adjust timing window based on pain level
        painLevelInput.addEventListener('input', () => {
            const painLevel = parseInt(painLevelInput.value);
            windowSize = 0.5 + (painLevel - 1) / 9 * 1.5; // Ranges from 0.5s (pain=1) to 2s (pain=10)
        });

        // Start the experience
        startButton.addEventListener('click', () => {
            startTime = performance.now() / 1000; // Current time in seconds
            isStarted = true;
            startButton.style.display = 'none';
            breathingButton.style.display = 'block';

            // Start sphere animation (expands and contracts every 10s)
            sphere.setAttribute('animation', {
                property: 'scale',
                from: '1 1 1',
                to: '1.5 1.5 1.5',
                dur: period * 1000 / 2, // 5s to expand, 5s to contract
                easing: 'linear',
                loop: true,
                dir: 'alternate'
            });
        });

        // Handle breathing button clicks
        breathingButton.addEventListener('click', () => {
            if (!isStarted) return;

            const currentTime = performance.now() / 1000;
            const t = currentTime - startTime; // Time elapsed since start
            const closestTarget = Math.round(t / period) * period; // Nearest target time (0, 10, 20, etc.)
            const diff = Math.abs(t - closestTarget); // Difference from target

            // Check if click is within the timing window
            if (diff < windowSize) {
                counter++;
            } else {
                counter = 0; // Reset on mismatch
            }

            // Update UI and provide feedback
            counterDisplay.textContent = `Matches: ${counter}`;
            if (counter >= 3) {
                sphere.setAttribute('color', 'green'); // Success feedback
            } else {
                sphere.setAttribute('color', 'red'); // Default/mismatch feedback
            }
        });
    </script>
</body>
</html>

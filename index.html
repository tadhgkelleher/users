<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cosmic Mandala Generator</title>
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      text-align: center;
      background-color: #0a0a0a;
      color: #ccc;
      margin: 0;
      padding: 20px;
      transition: background-color 0.5s, color 0.5s;
      overflow-x: hidden;
    }

    h1 {
      margin-bottom: 20px;
      color: #a0f;
      text-shadow: 0 0 15px rgba(170, 0, 255, 0.5);
      font-size: 3rem;
      letter-spacing: 1px;
    }

    canvas {
      border: 3px solid #333;
      margin: 20px auto;
      display: block;
      background-color: #111;
      box-shadow: 5px 5px 30px rgba(0, 0, 0, 0.7);
      border-radius: 15px;
      transition: box-shadow 0.3s;
    }

    canvas:hover {
      box-shadow: 0 0 30px rgba(173, 216, 230, 0.6);
    }

    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .control-panel {
      background-color: #181818;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s;
    }

    button, select {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #7c4dff;
      color: #fff;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
    }

    button:hover, select:hover {
      background-color: #6a3ab5;
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }

    input[type="number"], input[type="range"] {
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background-color: #2a2a2a;
      color: #eee;
      width: 75px;
      outline: none;
    }

    input[type="color"] {
      width: 50px;
      height: 30px;
      padding: 5px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      cursor: pointer;
      border: 3px solid #444;
      border-radius: 6px;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    
    input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 5px;
    }
    
    .parameter_input {
      padding: 8px;
      margin: 12px;
      position: relative;
      transition: transform 0.2s;
    }
    
    .parameter_input:hover {
      transform: scale(1.05);
    }

    label {
      color: #b39ddb;
      display: block;
      margin-bottom: 6px;
      font-size: 15px;
    }

    .color-palette {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 18px;
    }

    .color-option {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid #555;
      transition: transform 0.2s, border 0.2s;
    }

    .color-option:hover {
      transform: scale(1.2);
      border: 3px solid #fff;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }

    .tooltip {
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #444;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      white-space: nowrap;
      z-index: 10;
    }

    .parameter_input:hover .tooltip {
      opacity: 1;
    }

    .tab-container {
      margin-bottom: 18px;
    }

    .tab {
      padding: 10px 20px;
      margin: 0 6px;
      background-color: #444;
      border: none;
      border-radius: 6px 6px 0 0;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background-color 0.3s, color 0.3s;
    }

    .tab.active {
      background-color: #7c4dff;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 20px;
      background-color: #181818;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .tab-content.active {
      display: block;
    }

    .animation-controls {
      margin: 20px 0;
    }

    @keyframes pulse {
      0% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 0.6; transform: scale(1); }
    }

    .pulsate {
      animation: pulse 2.5s infinite ease-in-out;
    }

    .theme-option {
      display: inline-block;
      width: 30px;
      height: 30px;
      margin: 0 6px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid #555;
      transition: border 0.3s;
    }

    .gallery {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 25px;
    }

    .gallery-item {
      width: 175px;
      height: 175px;
      border: 3px solid #555;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .gallery-item:hover {
      transform: scale(1.1);
    }

    .preset-container {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .preset-btn {
      background-color: #3f51b5;
      padding: 10px 18px;
      font-size: 15px;
    }
    
    #download {
      background-color: #5c6bc0;
    }
    
    #download:hover {
      background-color: #455a64;
    }

    #random {
      background-color: #9c27b0;
    }
    
    #random:hover {
      background-color: #7b1fa2;
    }

    #animate {
      background-color: #d32f2f;
    }
    
    #animate:hover {
      background-color: #c62828;
    }

    #vrButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 24px;
      font-size: 17px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      z-index: 100;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #vrButton:hover {
      background-color: #43a047;
      transform: translateY(-2px);
    }

    #vrButton:active {
      transform: translateY(0);
    }

    #frequencyControls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    #frequencyControls label {
      margin-bottom: 5px;
    }

    #frequencyControls input[type="range"] {
      width: 200px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: center;
      }
      
      .parameter_input {
        text-align: left;
      }
      
      canvas {
        max-width: 100%;
        height: auto;
      }

      #vrButton {
        bottom: 10px;
        right: 10px;
        padding: 8px 16px;
        font-size: 14px;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <h1>Cosmic Mandala Generator</h1>

  <div class="tab-container">
    <button class="tab active" onclick="openTab(event, 'basicTab')">Basic</button>
    <button class="tab" onclick="openTab(event, 'advancedTab')">Advanced</button>
    <button class="tab" onclick="openTab(event, 'themeTab')">Themes</button>
    <button class="tab" onclick="openTab(event, 'spiritualTab')">Spiritual</button>
  </div>

  <div id="basicTab" class="tab-content active">
    <div class="control-panel">
      <div class="controls">
        <div class="parameter_input">
          <span class="tooltip">Number of radial segments</span>
          <label for="segments">Segments</label>
          <input type="range" id="segments" value="12" min="3" max="36" oninput="updateValue('segments')">
          <span id="segments-value">12</span>
        </div>
        <div class="parameter_input">
          <span class="tooltip">Recursion depth</span>
          <label for="levels">Levels</label>
          <input type="range" id="levels" value="4" min="1" max="8" oninput="updateValue('levels')">
          <span id="levels-value">4</span>
        </div>
        <div class="parameter_input">
          <span class="tooltip">Size reduction factor</span>
          <label for="scaleFactor">Scale</label>
          <input type="range" id="scaleFactor" value="0.5" min="0.1" max="0.9" step="0.05" oninput="updateValue('scaleFactor')">
          <span id="scaleFactor-value">0.5</span>
        </div>
        <div class="parameter_input">
          <span class="tooltip">Starting radius</span>
          <label for="initialRadius">Radius</label>
          <input type="range" id="initialRadius" value="100" min="10" max="200" oninput="updateValue('initialRadius')">
          <span id="initialRadius-value">100</span>
        </div>
        <div class="parameter_input">
          <span class="tooltip">Primary color</span>
          <label for="lineColor">Color</label>
          <input type="color" id="lineColor" value="#ffffff">
        </div>
      </div>
    </div>
    
    <div class="preset-container">
      <button class="preset-btn" onclick="loadPreset('floral')">Floral</button>
      <button class="preset-btn" onclick="loadPreset('star')">Star</button>
      <button class="preset-btn" onclick="loadPreset('crystal')">Crystal</button>
      <button class="preset-btn" onclick="loadPreset('cosmic')">Cosmic</button>
      <button class="preset-btn" onclick="loadPreset('psychedelic')">Psychedelic</button>
    </div>
  </div>

  <div id="advancedTab" class="tab-content">
    <div class="control-panel">
      <div class="controls">
        <div class="parameter_input">
          <span class="tooltip">Thickness of lines</span>
          <label for="lineWidth">Line Width</label>
          <input type="range" id="lineWidth" value="1" min="0.5" max="5" step="0.5" oninput="updateValue('lineWidth')">
          <span id="lineWidth-value">1</span>
        </div>
        <div class="parameter_input">
          <span class="tooltip">Rotation angle of the mandala</span>
          <label for="rotation">Rotation</label>
          <input type="range" id="rotation" value="0" min="0" max="360" oninput="updateValue('rotation')">
          <span id="rotation-value">0째</span>
        </div>
        <div class="parameter_input">
          <span class="tooltip">Style of line endings</span>
          <label for="lineCap">Line Style</label>
          <select id="lineCap">
            <option value="round">Round</option>
            <option value="butt">Flat</option>
            <option value="square">Square</option>
          </select>
        </div>
        <div class="parameter_input">
          <span class="tooltip">Secondary color for gradient</span>
          <label for="secondaryColor">2nd Color</label>
          <input type="color" id="secondaryColor" value="#ff6347">
        </div>
        <div class="parameter_input">
          <span class="tooltip">Pattern variation</span>
          <label for="patternType">Pattern</label>
          <select id="patternType">
            <option value="circles">Circles</option>
            <option value="triangles">Triangles</option>
            <option value="squares">Squares</option>
            <option value="mixed">Mixed</option>
            <option value="stars">Stars</option>
            <option value="waves">Waves</option>
          </select>
        </div>
      </div>
    </div>

    <div class="animation-controls">
      <button id="animate">Animate</button>
      <select id="animationType">
        <option value="rotate">Rotate</option>
        <option value="pulse">Pulse</option>
        <option value="evolve">Evolve</option>
        <option value="colorShift">Color Shift</option>
        <option value="complex">Complex</option>
      </select>
    </div>
  </div>

  <div id="themeTab" class="tab-content">
    <div class="control-panel">
      <h3>Color Themes</h3>
      <div class="color-palette">
        <div class="color-option" style="background: linear-gradient(45deg, #ff6347, #ff8c69);" onclick="setColorTheme('#ff6347', '#ff8c69')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #4682b4, #87ceeb);" onclick="setColorTheme('#4682b4', '#87ceeb')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #9932cc, #da70d6);" onclick="setColorTheme('#9932cc', '#da70d6')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #3cb371, #98fb98);" onclick="setColorTheme('#3cb371', '#98fb98')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #ffd700, #ffffe0);" onclick="setColorTheme('#ffd700', '#ffffe0')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #ff4500, #ffa07a);" onclick="setColorTheme('#ff4500', '#ffa07a')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #00ced1, #afeeee);" onclick="setColorTheme('#00ced1', '#afeeee')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #9400d3, #ee82ee);" onclick="setColorTheme('#9400d3', '#ee82ee')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #000000, #333333);" onclick="setColorTheme('#000000', '#333333')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #2980b9, #6dd5fa);" onclick="setColorTheme('#2980b9', '#6dd5fa')"></div>
        <div class="color-option" style="background: linear-gradient(45deg, #8e44ad, #c0392b);" onclick="setColorTheme('#8e44ad', '#c0392b')"></div>
      </div>

      <h3>Background Themes</h3>
      <div class="theme-option" style="background-color: #0a0a0a;" onclick="setTheme('#0a0a0a', '#ccc')"></div>
      <div class="theme-option" style="background-color: #1a2639;" onclick="setTheme('#1a2639', '#eee')"></div>
      <div class="theme-option" style="background-color: #231b1b;" onclick="setTheme('#231b1b', '#eee')"></div>
      <div class="theme-option" style="background-color: #22333b;" onclick="setTheme('#22333b', '#eee')"></div>
      <div class="theme-option" style="background-color: #f5f5f5;" onclick="setTheme('#f5f5f5', '#333')"></div>
      <div class="theme-option" style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YmVhY2h8ZW58MHx8MHx8fDA%3D&w=1000&q=80'); background-size: cover;" onclick="setTheme('url(https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YmVhY2h8ZW58MHx8MHx8fDA%3D&w=1000&q=80)', '#333')"></div>
      <div class="theme-option" style="background-image: url('https://images.unsplash.com/photo-1503366514048-11e02d95a5c8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bmVidWxhfGVufDB8fDB8fHww&w=1000&q=80'); background-size: cover;" onclick="setTheme('url(https://images.unsplash.com/photo-1503366514048-11e02d95a5c8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bmVidWxhfGVufDB8fDB8fHww&w=1000&q=80)', '#eee')"></div>
    </div>
  </div>

    <div id="spiritualTab" class="tab-content">
    <div class="control-panel">
      <h3>VR Experience</h3>
      <p>Enter a fully immersive VR experience with your mandala.</p>
      <button id="vrButton">Enter VR Mode</button>

      <h3>Frequency Generator</h3>
      <div id="frequencyControls">
        <label for="frequency">Binaural Beat Frequency (Hz):</label>
        <input type="range" id="frequency" min="1" max="40" value="7.83" step="0.01">
        <span id="frequencyValue">7.83 Hz</span>
        <p><i>Currently set to <span id="brainwaveState">Schumann Resonance</span>.</i></p>
      </div>
    </div>
  </div>

  <div class="button-group">
    <button id="generate">Generate</button>
    <button id="random">Random</button>
    <button id="download">Download</button>
  </div>

  <canvas id="mandalaCanvas" width="600" height="600"></canvas>

  <script>
    const canvas = document.getElementById('mandalaCanvas');
    const ctx = canvas.getContext('2d');
    
    let animationId = null;
    let isAnimating = false;
    let animationParams = {
      angle: 0,
      scale: 1,
      evolution: 0,
      colorHue: 0
    };

    document.getElementById('vrButton').addEventListener('click', function() {
      alert('VR Mode not yet implemented. Imagine a serene, immersive experience!');
    });

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillatorLeft = audioContext.createOscillator();
    const oscillatorRight = audioContext.createOscillator();
    const gainNodeLeft = audioContext.createGain();
    const gainNodeRight = audioContext.createGain();

    oscillatorLeft.connect(gainNodeLeft);
    oscillatorRight.connect(gainNodeRight);
    gainNodeLeft.connect(audioContext.destination);
    gainNodeRight.connect(audioContext.destination);

    oscillatorLeft.type = 'sine';
    oscillatorRight.type = 'sine';

    gainNodeLeft.gain.value = 0.5;
    gainNodeRight.gain.value = 0.5;

    oscillatorLeft.start();
    oscillatorRight.start();

    const frequencySlider = document.getElementById('frequency');
    const frequencyValueDisplay = document.getElementById('frequencyValue');
    const brainwaveStateDisplay = document.getElementById('brainwaveState');

    frequencySlider.addEventListener('input', function() {
      const baseFrequency = 200;
      const beatFrequency = parseFloat(this.value);
      const leftFrequency = baseFrequency - beatFrequency / 2;
      const rightFrequency = baseFrequency + beatFrequency / 2;

      oscillatorLeft.frequency.setValueAtTime(leftFrequency, audioContext.currentTime);
      oscillatorRight.frequency.setValueAtTime(rightFrequency, audioContext.currentTime);
      frequencyValueDisplay.textContent = beatFrequency.toFixed(2) + ' Hz';

      let state = '';
      if (beatFrequency >= 0.5 && beatFrequency < 4) {
        state = 'Delta (Deep Sleep/Healing)';
      } else if (beatFrequency >= 4 && beatFrequency < 8) {
        state = 'Theta (Meditation/Creativity)';
      } else if (beatFrequency >= 7 && beatFrequency < 13) {
        state = 'Alpha (Relaxation/Awareness)';
      } else if (beatFrequency >= 12 && beatFrequency < 30) {
        state = 'Beta (Alertness/Focus)';
      } else if (beatFrequency >= 30) {
        state = 'Gamma (Insight/Information Processing)';
      } else {
        state = 'Schumann Resonance (Earth\'s Natural Frequency)';
      }

      brainwaveStateDisplay.textContent = state;
    });

    function init() {
      document.getElementById('generate').addEventListener('click', generateMandala);
      document.getElementById('random').addEventListener('click', randomizeMandala);
      document.getElementById('download').addEventListener('click', downloadMandala);
      document.getElementById('animate').addEventListener('click', toggleAnimation);
      frequencySlider.dispatchEvent(new Event('input'));

      updateValueDisplays();
      generateMandala();
    }

    function updateValueDisplays() {
      document.getElementById('segments-value').textContent = document.getElementById('segments').value;
      document.getElementById('levels-value').textContent = document.getElementById('levels').value;
      document.getElementById('scaleFactor-value').textContent = document.getElementById('scaleFactor').value;
      document.getElementById('initialRadius-value').textContent = document.getElementById('initialRadius').value;
      document.getElementById('lineWidth-value').textContent = document.getElementById('lineWidth').value;
      document.getElementById('rotation-value').textContent = document.getElementById('rotation').value + '째';
    }

    function updateValue(id) {
      document.getElementById(id + '-value').textContent = id === 'rotation'
        ? document.getElementById(id).value + '째'
        : document.getElementById(id).value;
      
      if (!isAnimating) {
        generateMandala();
      }
    }

    function generateMandala() {
      const numSegments = parseInt(document.getElementById('segments').value);
      const levels = parseInt(document.getElementById('levels').value);
      const scaleFactor = parseFloat(document.getElementById('scaleFactor').value);
      const initialRadius = parseInt(document.getElementById('initialRadius').value);
      const lineColor = document.getElementById('lineColor').value;
      const secondaryColor = document.getElementById('secondaryColor').value;
      const lineWidth = parseFloat(document.getElementById('lineWidth').value);
      const rotation = parseInt(document.getElementById('rotation').value) * Math.PI / 180;
      const lineCap = document.getElementById('lineCap').value;
      const patternType = document.getElementById('patternType').value;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(rotation);
      ctx.translate(-centerX, -centerY);

      function drawRecursiveShape(x, y, radius, level) {
        if (level > levels) return;
        
        const gradient = ctx.createLinearGradient(
          centerX - radius, centerY - radius,
          centerX + radius, centerY + radius
        );
        gradient.addColorStop(0, lineColor);
        gradient.addColorStop(1, secondaryColor);
        
        ctx.lineWidth = lineWidth * (1 - (level-1) / levels * 0.5);
        ctx.lineCap = lineCap;
        
        let shape = patternType;
        if (patternType === 'mixed') {
          const shapes = ['circles', 'triangles', 'squares', 'stars', 'waves'];
          shape = shapes[level % shapes.length];
        }

        switch (shape) {
          case 'triangles':
            drawTriangle(x, y, radius, gradient);
            break;
          case 'squares':
            drawSquare(x, y, radius, gradient);
            break;
          case 'stars':
            drawStar(x, y, radius, gradient, 5);
            break;
          case 'waves':
            drawWave(x, y, radius, gradient);
            break;
          default:
            drawCircle(x, y, radius, gradient);
        }

        drawRecursiveShape(x, y, radius * scaleFactor, level + 1);
      }

      function drawCircle(x, y, radius, gradient) {
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = gradient;
        ctx.stroke();
      }

      function drawTriangle(x, y, radius, gradient) {
        const sides = 3;
        ctx.beginPath();
        for (let i = 0; i < sides; i++) {
          const angle = (i / sides) * 2 * Math.PI;
          const pointX = x + radius * Math.cos(angle);
          const pointY = y + radius * Math.sin(angle);
          
          if (i === 0) {
            ctx.moveTo(pointX, pointY);
          } else {
            ctx.lineTo(pointX, pointY);
          }
        }
        ctx.closePath();
        ctx.strokeStyle = gradient;
        ctx.stroke();
      }

      function drawSquare(x, y, radius, gradient) {
        const size = radius * 1.8;
        ctx.beginPath();
        ctx.rect(x - size/2, y - size/2, size, size);
        ctx.strokeStyle = gradient;
        ctx.stroke();
      }

      function drawStar(x, y, radius, gradient, points) {
          ctx.save();
          ctx.translate(x, y);
          ctx.rotate(Math.PI / points);

          ctx.beginPath();
          for (let i = 0; i < 2 * points; i++) {
              const angle = i * Math.PI / points;
              const r = (i % 2 === 0) ? radius : radius / 2;
              const starX = r * Math.cos(angle);
              const starY = r * Math.sin(angle);
              ctx.lineTo(starX, starY);
          }
          ctx.closePath();
          ctx.fillStyle = gradient;
          ctx.fill();  // Fill the star
          ctx.strokeStyle = gradient;
          ctx.stroke();
          ctx.restore();
      }

      function drawWave(x, y, radius, gradient) {
        ctx.beginPath();
        ctx.moveTo(x - radius, y);
        ctx.quadraticCurveTo(x, y - radius, x + radius, y);
        ctx.quadraticCurveTo(x, y + radius, x - radius, y);
        ctx.closePath();
        ctx.fillStyle = gradient;
        ctx.fill();
        ctx.strokeStyle = gradient;
        ctx.stroke();
      }

      for (let i = 0; i < numSegments; i++) {
        const angle = (i / numSegments) * 2 * Math.PI;
        const x = centerX + initialRadius * Math.cos(angle);
        const y = centerY + initialRadius * Math.sin(angle);
        
        drawRecursiveShape(x, y, initialRadius * scaleFactor, 1);
      }
      
      ctx.restore();
    }

    function randomizeMandala() {
      document.getElementById('segments').value = Math.floor(Math.random() * 33) + 3;
      document.getElementById('levels').value = Math.floor(Math.random() * 7) + 1;
      document.getElementById('scaleFactor').value = (Math.random() * 0.8 + 0.1).toFixed(2);
      document.getElementById('initialRadius').value = Math.floor(Math.random() * 190) + 10;
      document.getElementById('lineWidth').value = (Math.random() * 4.5 + 0.5).toFixed(1);
      document.getElementById('rotation').value = Math.floor(Math.random() * 360);
      
      document.getElementById('lineColor').value = randomColor();
      document.getElementById('secondaryColor').value = randomColor();
      
      const patterns = ['circles', 'triangles', 'squares', 'stars', 'waves'];
      document.getElementById('patternType').value = patterns[Math.floor(Math.random() * patterns.length)];
      
      const caps = ['round', 'butt', 'square'];
      document.getElementById('lineCap').value = caps[Math.floor(Math.random() * caps.length)];
      
      updateValueDisplays();
      generateMandala();
    }

    function randomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function downloadMandala() {
      const link = document.createElement('a');
      link.download = 'fractal-mandala.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function toggleAnimation() {
      const animationType = document.getElementById('animationType').value;
      
      if (isAnimating) {
        cancelAnimationFrame(animationId);
        document.getElementById('animate').textContent = 'Animate';
        isAnimating = false;
      } else {
        document.getElementById('animate').textContent = 'Stop';
        isAnimating = true;
        animationParams = { angle: 0, scale: 1, evolution: 0, colorHue: 0 };
        
        const animate = () => {
          switch (animationType) {
            case 'rotate':
              animateRotation();
              break;
            case 'pulse':
              animatePulse();
              break;
            case 'evolve':
              animateEvolution();
              break;
            case 'colorShift':
              animateColorShift();
              break;
            case 'complex':
              animateComplex();
              break;
          }
          
          if (isAnimating) {
            animationId = requestAnimationFrame(animate);
          }
        };
        
        animate();
      }
    }

    function animateRotation() {
      document.getElementById('rotation').value =
        (parseInt(document.getElementById('rotation').value) + 1) % 360;
      document.getElementById('rotation-value').textContent =
        document.getElementById('rotation').value + '째';
      generateMandala();
    }

    function animatePulse() {
      animationParams.scale = 0.95 + Math.sin(animationParams.angle) * 0.05;
      animationParams.angle += 0.05;
      
      const currentRadius = parseInt(document.getElementById('initialRadius').value);
      const baseRadius = 100;
      const newRadius = Math.floor(baseRadius * animationParams.scale);
      
      document.getElementById('initialRadius').value = newRadius;
      document.getElementById('initialRadius-value').textContent = newRadius;
      
      generateMandala();
    }

    function animateEvolution() {
      animationParams.evolution += 0.01;
      
      const scaleFactor = 0.3 + 0.4 * Math.sin(animationParams.evolution * 0.5);
      document.getElementById('scaleFactor').value = scaleFactor.toFixed(2);
      document.getElementById('scaleFactor-value').textContent = scaleFactor.toFixed(2);
      
      if (Math.floor(animationParams.evolution * 10) % 20 === 0) {
        const segments = parseInt(document.getElementById('segments').value);
        document.getElementById('segments').value =
          ((segments + 1) > 36) ? 3 : segments + 1;
        document.getElementById('segments-value').textContent =
          document.getElementById('segments').value;
      }
      
      generateMandala();
    }

    function animateColorShift() {
        animationParams.colorHue = (animationParams.colorHue + 1) % 360; // Cycle through hues

        // Convert HSL to hex for primary color
        let hsl = `hsl(${animationParams.colorHue}, 100%, 50%)`;
        document.getElementById('lineColor').value = hslToHex(hsl);

        // Convert HSL to hex for secondary color (shifted hue)
        let secondaryHue = (animationParams.colorHue + 180) % 360; // Opposite hue
        let secondaryHsl = `hsl(${secondaryHue}, 100%, 50%)`;
        document.getElementById('secondaryColor').value = hslToHex(secondaryHsl);

        generateMandala();
    }

    function animateComplex() {
        animateEvolution(); // Incorporate evolution
        animateRotation(); // Incorporate rotation
        animateColorShift(); // Incorporate color shift
    }

    function hslToHex(hsl) {
        let sep = hsl.indexOf(",") > -1 ? "," : " ";
        hsl = hsl.substring(4).split(")")[0].split(sep);

        let h = parseInt(hsl[0]) / 360;
        let s = parseInt(hsl[1].substring(0, hsl[1].length - 1)) / 100;
        let l = parseInt(hsl[2].substring(0, hsl[2].length - 1)) / 100;

        let r, g, b;

        if (s === 0) {
            r = g = b = l; // achromatic
        } else {
            const hue2rgb = (p, q, t) => {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1/6) return p + (q - p) * 6 * t;
                if (t < 1/2) return q;
                if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
            };

            const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            const p = 2 * l - q;
            r = hue2rgb(p, q, h + 1/3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1/3);
        }

        const toHex = x => {
            const shortHex = Math.round(x * 255).toString(16);
            return shortHex.length === 1 ? "0" + shortHex : shortHex;
        };

        return "#" + toHex(r) + toHex(g) + toHex(b);
    }

    function loadPreset(type) {
      switch(type) {
        case 'floral':
          document.getElementById('segments').value = 8;
          document.getElementById('levels').value = 5;
          document.getElementById('scaleFactor').value = 0.7;
          document.getElementById('initialRadius').value = 130;
          document.getElementById('lineWidth').value = 1.5;
          document.getElementById('rotation').value = 25;
          document.getElementById('lineColor').value = '#ff7eb9';
          document.getElementById('secondaryColor').value = '#7afcff';
          document.getElementById('patternType').value = 'circles';
          document.getElementById('lineCap').value = 'round';
          break;
        case 'star':
          document.getElementById('segments').value = 12;
          document.getElementById('levels').value = 3;
          document.getElementById('scaleFactor').value = 0.55;
          document.getElementById('initialRadius').value = 150;
          document.getElementById('lineWidth').value = 2;
          document.getElementById('rotation').value = 15;
          document.getElementById('lineColor').value = '#ffd700';
          document.getElementById('secondaryColor').value = '#ff4500';
          document.getElementById('patternType').value = 'triangles';
          document.getElementById('lineCap').value = 'butt';
          break;
        case 'crystal':
          document.getElementById('segments').value = 6;
          document.getElementById('levels').value = 7;
          document.getElementById('scaleFactor').value = 0.6;
          document.getElementById('initialRadius').value = 120;
          document.getElementById('lineWidth').value = 1;
          document.getElementById('rotation').value = 30;
          document.getElementById('lineColor').value = '#00ffff';
          document.getElementById('secondaryColor').value = '#4169e1';
          document.getElementById('patternType').value = 'squares';
          document.getElementById('lineCap').value = 'square';
          break;
        case 'cosmic':
          document.getElementById('segments').value = 24;
          document.getElementById('levels').value = 4;
          document.getElementById('scaleFactor').value = 0.4;
          document.getElementById('initialRadius').value = 140;
          document.getElementById('lineWidth').value = 1.5;
          document.getElementById('rotation').value = 0;
          document.getElementById('lineColor').value = '#9400d3';
          document.getElementById('secondaryColor').value = '#ff1493';
          document.getElementById('patternType').value = 'mixed';
          document.getElementById('lineCap').value = 'round';
          break;
        case 'psychedelic':
          document.getElementById('segments').value = 16;
          document.getElementById('levels').value = 6;
          document.getElementById('scaleFactor').value = 0.65;
          document.getElementById('initialRadius').value = 110;
          document.getElementById('lineWidth').value = 2;
          document.getElementById('rotation').value = 45;
          document.getElementById('lineColor').value = '#ff00ff';
          document.getElementById('secondaryColor').value = '#00ffff';
          document.getElementById('patternType').value = 'waves';
          document.getElementById('lineCap').value = 'round';
          break;
      }
      
      updateValueDisplays();
      generateMandala();
    }

    function setColorTheme(primary, secondary) {
      document.getElementById('lineColor').value = primary;
      document.getElementById('secondaryColor').value = secondary;
      generateMandala();
    }

    function setTheme(bg, text) {
      document.body.style.backgroundColor = bg;
      document.body.style.color = text;
      generateMandala();
    }

    function openTab(evt, tabName) {
      const tabcontent = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
      }
      
      const tablinks = document.getElementsByClassName("tab");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
      }
      
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    window.onload = init;
  </script>
</body>
</html>

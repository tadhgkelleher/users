<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Keep existing meta tags and styles -->
    <style>
        /* Add to existing styles */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #333;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .password-container {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 35px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Keep existing HTML structure -->

    <script>
        // Improved Firebase initialization
        const firebaseConfig = {
            apiKey: "AIzaSyA8nC973Wex5WJVgovi_MVzDtmuL4IOhjE",
            authDomain: "mandala-5165e.firebaseapp.com",
            projectId: "mandala-5165e",
            storageBucket: "mandala-5165e.appspot.com",
            messagingSenderId: "569537405023",
            appId: "1:569537405023:web:e7f795e6280f7a21e9bbea",
            measurementId: "G-TER99X7NBT",
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        // DOM Elements
        const elements = {
            profile: document.querySelector('.profile'),
            signInSection: document.getElementById('signInSection'),
            invitationSection: document.getElementById('invitationSection'),
            // Add more element references as needed
        };

        // State management
        let state = {
            currentUser: null,
            isLoading: false,
            inviteId: new URLSearchParams(window.location.search).get('inviteId')
        };

        // Utility functions
        const utils = {
            showLoader(button) {
                button.setAttribute('data-original-text', button.textContent);
                button.innerHTML = `<div class="loading"></div>`;
                button.disabled = true;
            },
            hideLoader(button) {
                if (button.getAttribute('data-original-text')) {
                    button.textContent = button.getAttribute('data-original-text');
                    button.disabled = false;
                }
            },
            togglePassword(inputId) {
                const input = document.getElementById(inputId);
                const type = input.type === 'password' ? 'text' : 'password';
                input.type = type;
            }
        };

        // Auth functions
        const authHandlers = {
            async handleSignIn(email, password) {
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    return true;
                } catch (error) {
                    throw this.getAuthError(error);
                }
            },

            async handleSignUp(email, password) {
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await this.sendEmailVerification(userCredential.user);
                    return userCredential;
                } catch (error) {
                    throw this.getAuthError(error);
                }
            },

            async sendEmailVerification(user) {
                try {
                    await user.sendEmailVerification();
                } catch (error) {
                    console.error('Verification email error:', error);
                }
            },

            getAuthError(error) {
                const errorMap = {
                    'auth/wrong-password': 'Invalid password',
                    'auth/user-not-found': 'User not found',
                    'auth/email-already-in-use': 'Email already in use',
                    'auth/weak-password': 'Password should be at least 6 characters'
                };
                return errorMap[error.code] || error.message;
            }
        };

        // Invitation functions
        const invitationHandlers = {
            async generateInvitationLink(userId) {
                const inviteId = Math.random().toString(36).substr(2, 9);
                const inviteData = {
                    fromUserId: userId,
                    status: 'open',
                    createdAt: FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 1 week expiration
                };

                await db.collection('invitations').doc(inviteId).set(inviteData);
                return `${window.location.origin}?inviteId=${inviteId}`;
            },

            async validateInvitation(inviteId) {
                if (!inviteId) return null;
                
                const doc = await db.collection('invitations').doc(inviteId).get();
                if (!doc.exists) throw new Error('Invalid invitation link');
                
                const data = doc.data();
                if (data.status !== 'open') throw new Error('Invitation already used');
                if (new Date(data.expiresAt) < new Date()) throw new Error('Invitation expired');
                
                return data.fromUserId;
            },

            async acceptInvitation(inviteId, userId) {
                const batch = db.batch();
                const inviteRef = db.collection('invitations').doc(inviteId);
                
                batch.update(inviteRef, {
                    status: 'accepted',
                    acceptedBy: userId,
                    acceptedAt: FieldValue.serverTimestamp()
                });

                const userRef = db.collection('users').doc(userId);
                batch.set(userRef, {
                    invitedBy: inviteRef,
                    inviteAccepted: true
                }, { merge: true });

                await batch.commit();
            }
        };

        // UI functions
        const ui = {
            showElement(el) {
                el.classList.remove('hidden');
            },

            hideElement(el) {
                el.classList.add('hidden');
            },

            displayMessage(type, text, duration = 5000) {
                const message = document.getElementById('message');
                message.textContent = text;
                message.className = `message ${type}`;
                message.style.display = 'block';
                
                if (duration) {
                    setTimeout(() => {
                        message.style.display = 'none';
                    }, duration);
                }
            },

            async loadInvitations(userId) {
                const snapshot = await db.collection('invitations')
                    .where('fromUserId', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();

                const invitationsList = document.getElementById('invitationsList');
                invitationsList.innerHTML = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'invite-item';
                    item.innerHTML = `
                        <p>Invite ID: ${doc.id}</p>
                        <p>Status: ${data.status}</p>
                        ${data.acceptedBy ? `<p>Accepted by: ${data.acceptedBy}</p>` : ''}
                    `;
                    invitationsList.appendChild(item);
                });
            }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Add password toggles
            document.querySelectorAll('.password-container').forEach(container => {
                const toggle = document.createElement('span');
                toggle.className = 'toggle-password';
                toggle.textContent = 'ðŸ‘ï¸';
                toggle.onclick = () => utils.togglePassword(container.querySelector('input').id);
                container.appendChild(toggle);
            });

            // Handle invitation parameter
            try {
                if (state.inviteId) {
                    const fromUserId = await invitationHandlers.validateInvitation(state.inviteId);
                    ui.showElement(document.getElementById('signUpForm'));
                }
            } catch (error) {
                ui.displayMessage('error', error.message);
                history.replaceState(null, '', window.location.pathname);
            }

            auth.onAuthStateChanged(async user => {
                state.currentUser = user;
                if (user) {
                    await ui.loadInvitations(user.uid);
                    // Update UI for logged in state
                } else {
                    // Update UI for logged out state
                }
            });
        });

        // Add improved event handlers for forms
        document.getElementById('signInForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            utils.showLoader(button);
            
            try {
                await authHandlers.handleSignIn(
                    document.getElementById('signInEmail').value,
                    document.getElementById('signInPassword').value
                );
            } catch (error) {
                ui.displayMessage('error', error);
            } finally {
                utils.hideLoader(button);
            }
        });

        document.getElementById('signUpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            utils.showLoader(button);
            
            try {
                if (!state.inviteId) throw new Error('No invitation found');
                
                const userCredential = await authHandlers.handleSignUp(
                    document.getElementById('email').value,
                    document.getElementById('password').value
                );

                await invitationHandlers.acceptInvitation(state.inviteId, userCredential.user.uid);
                ui.displayMessage('success', 'Account created and invitation accepted!');
                setTimeout(() => window.location.replace('/'), 3000);
            } catch (error) {
                ui.displayMessage('error', error);
            } finally {
                utils.hideLoader(button);
            }
        });

        // Add remaining event handlers (sign out, generate link, etc.)
    </script>
</body>
</html>

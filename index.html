<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Authentic Gamelan Ensemble</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f1e9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; max-width: 700px; width: 100%; }
        h1 { font-size: 24px; color: #8b4513; margin-bottom: 20px; }
        button { background-color: #d2691e; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #cd5c5c; }
        input, select { padding: 8px; margin: 10px 5px; width: 70%; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .note-display { margin-top: 15px; font-size: 18px; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Authentic Gamelan Ensemble</h1>
        <div class="controls">
            <input type="text" id="balunganInput" placeholder="Enter balungan (e.g., 2 3 5 6)" value="2 3 5 6">
            <select id="presetBalungan" onchange="loadPreset()">
                <option value="">Select Preset</option>
                <option value="2 3 5 6">Lancaran (2 3 5 6)</option>
                <option value="6 5 3 2 6 5 3 2">Ketawang (6 5 3 2)</option>
                <option value="3 2 1 6 5 3 2 1">Ladrang (3 2 1 6 5 3 2 1)</option>
            </select>
            <select id="cycleLength">
                <option value="4">Cycle: 4 beats</option>
                <option value="8">Cycle: 8 beats</option>
                <option value="16">Cycle: 16 beats</option>
            </select>
            <button onclick="startGamelan()">Start</button>
            <button onclick="stopGamelan()">Stop</button>
            <button onclick="transitionIrama()">Transition Irama</button>
        </div>
        <div class="note-display" id="currentNote">Current Balungan: Stopped</div>
    </div>

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let oscillators = [];
        let isPlaying = false;
        let currentIrama = 'lancer';
        let targetIramaTiming = 4.0;
        let currentTiming = 4.0;

        const slendroScale = { 1: 240, 2: 270, 3: 300, 5: 360, 6: 400 };
        const instruments = {
            gong: { freq: 55, type: 'sine', gain: 0.6, decay: 2.5, filterFreq: 100 },
            kempul: { freqMult: 0.5, type: 'sine', gain: 0.4, decay: 1.5, filterFreq: 200 },
            kenong: { freqMult: 1.5, type: 'triangle', gain: 0.35, decay: 1.0, filterFreq: 800 },
            saronBarung: { freqMult: 1, type: 'triangle', gain: 0.25, decay: 0.6, filterFreq: 1000 },
            saronPanerus: { freqMult: 2, type: 'square', gain: 0.2, decay: 0.4, filterFreq: 1200 },
            bonangBarung: { freqMult: 2, type: 'triangle', gain: 0.2, decay: 0.5, filterFreq: 1500 },
            bonangPanerus: { freqMult: 4, type: 'square', gain: 0.15, decay: 0.3, filterFreq: 2000 },
            peking: { freqMult: 2, type: 'sawtooth', gain: 0.18, decay: 0.35, filterFreq: 1800 }
        };
        const iramaTimings = { lancer: 4.0, tanggung: 2.0, dados: 1.0 };
        const subdivisionsPerNote = { lancer: 8, tanggung: 4, dados: 2 };

        function createOscillator(frequency, type, gainValue, decay, filterFreq, startTime) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, startTime);
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(filterFreq, startTime);
            gainNode.gain.setValueAtTime(gainValue, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + decay);
            oscillator.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start(startTime);
            oscillator.stop(startTime + decay);
            return oscillator;
        }

        function playCycle(startTime, balungan, cycleLength) {
            const subdivisions = subdivisionsPerNote[currentIrama];
            balungan.forEach((note, index) => {
                if (slendroScale[note]) {
                    const beatTime = startTime + index * currentTiming;
                    const subTime = currentTiming / subdivisions;
                    const baseFreq = slendroScale[note];
                    const nextNote = balungan[(index + 1) % cycleLength];
                    const nextFreq = slendroScale[nextNote];

                    // Colotomic instruments
                    if (cycleLength === 4) {
                        if (index === 3) oscillators.push(createOscillator(
                            instruments.gong.freq, instruments.gong.type, instruments.gong.gain,
                            instruments.gong.decay, instruments.gong.filterFreq, beatTime
                        ));
                        if (index === 1 || index === 3) oscillators.push(createOscillator(
                            baseFreq * instruments.kenong.freqMult, instruments.kenong.type, instruments.kenong.gain,
                            instruments.kenong.decay, instruments.kenong.filterFreq, beatTime
                        ));
                        if (index === 0 || index === 2) oscillators.push(createOscillator(
                            baseFreq * instruments.kempul.freqMult, instruments.kempul.type, instruments.kempul.gain,
                            instruments.kempul.decay, instruments.kempul.filterFreq, beatTime
                        ));
                    }

                    // Saron Barung
                    oscillators.push(createOscillator(
                        baseFreq * instruments.saronBarung.freqMult, instruments.saronBarung.type, instruments.saronBarung.gain,
                        instruments.saronBarung.decay, instruments.saronBarung.filterFreq, beatTime
                    ));

                    // Peking
                    for (let k = 0; k < subdivisions; k++) {
                        const time = beatTime + k * subTime;
                        oscillators.push(createOscillator(
                            baseFreq * instruments.peking.freqMult, instruments.peking.type, instruments.peking.gain,
                            instruments.peking.decay, instruments.peking.filterFreq, time
                        ));
                    }

                    // Bonang Barung (interlocking)
                    for (let k = 0; k < subdivisions; k++) {
                        const time = beatTime + k * subTime;
                        const noteToPlay = (k % 2 === 0) ? note : nextNote;
                        oscillators.push(createOscillator(
                            slendroScale[noteToPlay] * instruments.bonangBarung.freqMult, instruments.bonangBarung.type,
                            instruments.bonangBarung.gain, instruments.bonangBarung.decay, instruments.bonangBarung.filterFreq, time
                        ));
                    }

                    // Bonang Panerus (with 3 against 4 in lancer)
                    if (currentIrama === 'lancer') {
                        const polyrhythmSubTime = (currentTiming * 4) / 3 / subdivisions;
                        for (let k = 0; k < 3; k++) {
                            const time = beatTime + k * polyrhythmSubTime;
                            oscillators.push(createOscillator(
                                baseFreq * instruments.bonangPanerus.freqMult, instruments.bonangPanerus.type,
                                instruments.bonangPanerus.gain, instruments.bonangPanerus.decay, instruments.bonangPanerus.filterFreq, time
                            ));
                        }
                    } else {
                        for (let k = 0; k < subdivisions; k++) {
                            const time = beatTime + k * subTime;
                            oscillators.push(createOscillator(
                                baseFreq * instruments.bonangPanerus.freqMult, instruments.bonangPanerus.type,
                                instruments.bonangPanerus.gain, instruments.bonangPanerus.decay, instruments.bonangPanerus.filterFreq, time
                            ));
                        }
                    }

                    setTimeout(() => {
                        document.getElementById('currentNote').textContent = 
                            `Current Balungan: ${note} (Irama: ${currentIrama}, Timing: ${currentTiming.toFixed(2)}s)`;
                    }, (beatTime - audioContext.currentTime) * 1000);
                }
            });

            if (isPlaying) {
                const nextCycleTime = startTime + cycleLength * currentTiming;
                setTimeout(() => playCycle(nextCycleTime, balungan, cycleLength), 
                    (nextCycleTime - audioContext.currentTime - 0.1) * 1000);
            }
        }

        function startGamelan() {
            if (!isPlaying) {
                isPlaying = true;
                const balungan = document.getElementById('balunganInput').value.split(' ').map(Number);
                const cycleLength = parseInt(document.getElementById('cycleLength').value);
                playCycle(audioContext.currentTime, balungan, cycleLength);
                setInterval(() => {
                    if (Math.abs(currentTiming - targetIramaTiming) > 0.01) {
                        currentTiming += (targetIramaTiming - currentTiming) * 0.05;
                    }
                }, 100);
            }
        }

        function transitionIrama() {
            if (currentIrama === 'lancer') { currentIrama = 'tanggung'; targetIramaTiming = iramaTimings.tanggung; }
            else if (currentIrama === 'tanggung') { currentIrama = 'dados'; targetIramaTiming = iramaTimings.dados; }
            else { currentIrama = 'lancer'; targetIramaTiming = iramaTimings.lancer; }
        }

        function stopGamelan() {
            isPlaying = false;
            oscillators.forEach(osc => osc.stop());
            oscillators = [];
            document.getElementById('currentNote').textContent = 'Current Balungan: Stopped';
        }

        function loadPreset() {
            const preset = document.getElementById('presetBalungan').value;
            if (preset) document.getElementById('balunganInput').value = preset;
        }
    </script>
</body>
</html>

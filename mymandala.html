<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Mandala - Profile</title>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8nC973Wex5WJVgovi_MVzDtmuL4IOhjE",
      authDomain: "mandala-5165e.firebaseapp.com",
      projectId: "mandala-5165e",
      storageBucket: "mandala-5165e.appspot.com",
      messagingSenderId: "569537405023",
      appId: "1:569537405023:web:e7f795e6280f7a21e9bbea",
      measurementId: "G-TER99X7NBT",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Fetch user data from Firestore
    async function getUserProfile(userId) {
      try {
        const userDocRef = doc(db, "users", userId);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
          return userDoc.data();
        } else {
          console.log("User not found");
        }
      } catch (error) {
        console.error("Error fetching user data:", error);
      }
    }

    // Update the user profile UI
    function displayUserProfile(userData) {
      const profilePic = userData.profilePic || "default-profile.png";
      const username = userData.username || "Unknown User";
      const email = userData.email;

      document.getElementById("profilePic").src = profilePic;
      document.getElementById("username").textContent = username;
      document.getElementById("email").textContent = email;
    }

    // Send an invitation to connect
    async function sendInvitation() {
      const inviteEmail = document.getElementById("inviteEmail").value.trim();
      const currentUser = auth.currentUser;

      if (inviteEmail) {
        try {
          const userDocRef = doc(db, "users", currentUser.uid);
          const userDoc = await getDoc(userDocRef);

          if (userDoc.exists()) {
            const userData = userDoc.data();

            // Send invite: Store the invite in Firestore under the sender's document
            const inviteRef = await addDoc(collection(db, "invitations"), {
              fromUserId: currentUser.uid,
              toEmail: inviteEmail,
              status: "pending",
              createdAt: new Date(),
            });

            // Send the invitation email using SendGrid
            await sendEmail(inviteEmail, userData.username); // Call SendGrid API to send the email

            alert(`Invitation sent to ${inviteEmail}!`);
          }
        } catch (error) {
          console.error("Error sending invitation:", error);
          alert("Error sending invitation.");
        }
      }
    }

    async function sendEmail(toEmail, fromUser) {
      const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer 0eARknq4RDS1I5kBbAMElQ',  // Your SendGrid API key
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          personalizations: [
            {
              to: [{ email: toEmail }],
              subject: `You have been invited to join ${fromUser}'s Mandala!`,
            },
          ],
          from: { email: 'your-email@example.com' },  // Replace with your verified sender email
          content: [
            {
              type: 'text/plain',
              value: `You have been invited by ${fromUser} to join their Mandala project. Please click the link below to join.\n\n[Insert Link to Join]`,
            },
          ],
        }),
      });

      if (response.ok) {
        console.log('Email sent!');
      } else {
        console.error('Error sending email:', response.statusText);
      }
    }

    // Handle authentication state change
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userProfile = await getUserProfile(user.uid);
        displayUserProfile(userProfile);

        // Show sent invitations if any
        const invitesContainer = document.getElementById("invitations");
        if (userProfile.invitationsSent && userProfile.invitationsSent.length > 0) {
          userProfile.invitationsSent.forEach(inviteEmail => {
            const inviteElement = document.createElement("div");
            inviteElement.textContent = `Invite sent to: ${inviteEmail}`;
            invitesContainer.appendChild(inviteElement);
          });
        }
      } else {
        window.location.href = "login.html"; // Redirect to login if not authenticated
      }
    });
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: #f0f0f0;
      color: #333;
    }

    .profile-container {
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      width: 100%;
    }

    .profile-container h2 {
      text-align: center;
    }

    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .profile-info {
      text-align: center;
    }

    .profile-info p {
      margin: 10px 0;
    }

    .send-invite {
      margin-top: 30px;
      text-align: center;
    }

    .send-invite input {
      padding: 10px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    .send-invite button {
      padding: 10px 20px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .send-invite button:hover {
      background: #0056b3;
    }

    .invitations {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <h2>User Profile</h2>
    <img id="profilePic" class="profile-pic" src="default-profile.png" alt="Profile Picture">
    <div class="profile-info">
      <p><strong>Username:</strong> <span id="username">Loading...</span></p>
      <p><strong>Email:</strong> <span id="email">Loading...</span></p>
    </div>

    <div class="send-invite">
      <h3>Send Invitation</h3>
      <input type="email" id="inviteEmail" placeholder="Enter email to invite">
      <button onclick="sendInvitation()">Send Invite</button>
    </div>

    <div id="invitations" class="invitations">
      <h3>Sent Invitations:</h3>
      <!-- Invitations will appear here -->
    </div>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding-top: 20px;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
            width: 90%;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .error-message {
            color: red;
            text-align: center;
            margin-bottom: 20px;
        }
        .nav-links {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        .nav-links a, .nav-links button {
            color: white;
            margin: 0 15px;
            text-decoration: none;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .nav-links a:hover, .nav-links button:hover {
            text-decoration: underline;
        }
        #inviteLink {
            display: none;
            margin-top: 10px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .share-buttons {
            margin-top: 20px;
        }
        .share-buttons button, #generateLinkBtn, #copyLinkBtn {
            margin: 5px;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .share-buttons button:hover, #generateLinkBtn:hover, #copyLinkBtn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="nav-links">
        <a href="invite.html">Invite</a>
        <a href="profile.html">Profile</a>
        <button id="signOutBtn">Sign Out</button>
    </div>

    <div class="container">
        <h1>Welcome to the Platform!</h1>
        <p id="welcomeMessage"></p>
        <div class="error-message" id="errorMessage"></div>

        <h2>Accepted Invitations</h2>
        <table id="invitationsTable">
            <thead>
                <tr>
                    <th>Accepted By</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>Generate Invitation Link</h2>
        <button id="generateLinkBtn">Generate Link</button>
        <input type="text" id="inviteLink" readonly>
        <button id="copyLinkBtn" style="display: none;">Copy Link</button>
    </div>

    <!-- Add React dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- Add visualization container -->
    <div id="visualization-root"></div>

    <!-- Firebase initialization and main functionality -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA8nC973Wex5WJVgovi_MVzDtmuL4IOhjE",
            authDomain: "mandala-5165e.firebaseapp.com",
            projectId: "mandala-5165e",
            storageBucket: "mandala-5165e.appspot.com",
            messagingSenderId: "569537405023",
            appId: "1:569537405023:web:e7f795e6280f7a21e9bbea",
            measurementId: "G-TER99X7NBT"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById("welcomeMessage").textContent = `Hello, ${user.email}!`;
                fetchAcceptedInvitations(user);
            } else {
                window.location.href = '/index.html';
            }
        });

        function fetchAcceptedInvitations(currentUser) {
            const invitationsTable = document.getElementById("invitationsTable").getElementsByTagName('tbody')[0];
            invitationsTable.innerHTML = "";

            db.collection("invitations").get()
                .then(snapshot => {
                    const allInvitations = [];
                    const acceptedUsersMap = new Map();

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const isSender = data.fromUserId === currentUser.uid;
                        const hasAccepted = data.acceptedByUser?.length > 0;
                        const isAcceptor = hasAccepted && data.acceptedByUser.some(u => u.email === currentUser.email);

                        if ((isSender || isAcceptor) && hasAccepted) {
                            allInvitations.push(data);
                            data.acceptedByUser.forEach(user => {
                                const key = user.email;
                                if (!acceptedUsersMap.has(key)) {
                                    acceptedUsersMap.set(key, user);
                                }
                            });
                        }
                    });

                    acceptedUsersMap.forEach(user => {
                        invitationsTable.innerHTML += `
                            <tr>
                                <td>${user.email}<br>${user.name}</td>
                            </tr>
                        `;
                    });

                    acceptedUsersMap.forEach(user => {
                        displayAcceptedInvitesByUser(user, allInvitations);
                    });
                })
                .catch(error => {
                    console.error("Error fetching invitations:", error);
                    document.getElementById("errorMessage").textContent = "Error loading invitations.";
                });
        }

        function displayAcceptedInvitesByUser(acceptedUser, invitations) {
            const sectionId = `userSection-${acceptedUser.email.replace(/[@.]/g, '_')}`;
            let section = document.getElementById(sectionId);

            if (section) section.remove();

            section = document.createElement('div');
            section.id = sectionId;
            section.innerHTML = `
                <h3>Invites Accepted by ${acceptedUser.name} (${acceptedUser.email})</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Invite From</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="${sectionId}-tbody"></tbody>
                </table>
            `;
            document.querySelector('.container').appendChild(section);

            const tbody = document.getElementById(`${sectionId}-tbody`);
            const userInvitations = invitations.filter(invite => 
                invite.acceptedByUser.some(u => u.email === acceptedUser.email)
            );

            userInvitations.forEach(invite => {
                tbody.innerHTML += `
                    <tr>
                        <td>${invite.fromUserEmail}</td>
                        <td>${invite.status}</td>
                    </tr>
                `;
            });
        }

        document.getElementById("generateLinkBtn").addEventListener("click", () => {
            const user = auth.currentUser;
            if (!user) return;
            
            const uniqueId = Math.random().toString(36).substr(2, 9);
            const inviteLink = `https://my-mandala.com/?inviteId=${uniqueId}`;

            db.collection("invitations").doc(uniqueId).set({
                fromUserId: user.uid,
                fromUserEmail: user.email,
                status: "open",
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            }).then(() => {
                const inviteLinkInput = document.getElementById("inviteLink");
                inviteLinkInput.value = inviteLink;
                inviteLinkInput.style.display = "block";
                document.getElementById("copyLinkBtn").style.display = "inline-block";
            });
        });

        document.getElementById("copyLinkBtn").addEventListener("click", () => {
            const inviteLinkInput = document.getElementById("inviteLink");
            inviteLinkInput.select();
            document.execCommand("copy");
            alert("Link copied to clipboard!");
        });

        document.getElementById("signOutBtn").addEventListener("click", () => {
            auth.signOut().then(() => {
                window.location.href = '/index.html';
            });
        });
    </script>

    <!-- Visualization Component -->
    <script type="text/babel">
        const CircularNodesVisualization = () => {
            const [nodes, setNodes] = React.useState([]);
            
            React.useEffect(() => {
                const observer = new MutationObserver((mutations) => {
                    const newNodes = [];
                    
                    // Get nodes from main invitation table
                    const mainTable = document.querySelector('#invitationsTable tbody');
                    if (mainTable) {
                        Array.from(mainTable.querySelectorAll('tr')).forEach(row => {
                            const email = row.querySelector('td')?.textContent?.split('\n')[0];
                            if (email) {
                                newNodes.push({ id: email, label: email, type: 'main' });
                            }
                        });
                    }
                    
                    // Get nodes from user sections
                    document.querySelectorAll('[id^="userSection-"]').forEach(section => {
                        const tbody = section.querySelector('tbody');
                        if (tbody) {
                            Array.from(tbody.querySelectorAll('tr')).forEach(row => {
                                const email = row.querySelector('td')?.textContent;
                                if (email) {
                                    newNodes.push({ id: email, label: email, type: 'sub' });
                                }
                            });
                        }
                    });
                    
                    setNodes([...new Map(newNodes.map(node => [node.id, node])).values()]);
                });
                
                observer.observe(document.querySelector('.container'), {
                    subtree: true,
                    childList: true
                });
                
                return () => observer.disconnect();
            }, []);
            
            const radius = 200;
            const centerX = 300;
            const centerY = 250;
            
            return (
                <div style={{ marginTop: '2rem', padding: '1rem', backgroundColor: 'white', borderRadius: '0.5rem', boxShadow: '0 1px 3px rgba(0,0,0,0.12)' }}>
                    <h2 style={{ fontSize: '1.25rem', fontWeight: 'bold', marginBottom: '1rem', textAlign: 'center' }}>Network Visualization</h2>
                    <svg viewBox="0 0 600 500" style={{ width: '100%', maxWidth: '600px', margin: '0 auto', display: 'block' }}>
                        {/* Draw connecting lines */}
                        {nodes.map((node, i) => (
                            <line
                                key={`line-${i}`}
                                x1={centerX}
                                y1={centerY}
                                x2={centerX + radius * Math.cos(i * 2 * Math.PI / nodes.length)}
                                y2={centerY + radius * Math.sin(i * 2 * Math.PI / nodes.length)}
                                stroke="#4CAF50"
                                strokeWidth="1"
                                opacity="0.3"
                            />
                        ))}
                        
                        {/* Draw center node */}
                        <circle
                            cx={centerX}
                            cy={centerY}
                            r="8"
                            fill="#4CAF50"
                        />
                        
                        {/* Draw outer nodes */}
                        {nodes.map((node, i) => {
                            const angle = i * 2 * Math.PI / nodes.length;
                            const x = centerX + radius * Math.cos(angle);
                            const y = centerY + radius * Math.sin(angle);
                            
                            return (
                                <g key={`node-${i}`}>
                                    <circle
                                        cx={x}
                                        cy={y}
                                        r="6"
                                        fill={node.type === 'main' ? '#4CAF50' : '#45a049'}
                                    />
                                    <text
                                        x={x}
                                        y={y + 20}
                                        textAnchor="middle"
                                        fontSize="12"
                                        fill="#333"
                                        transform={`rotate(${angle * 180 / Math.PI + (angle > Math.PI ? 180 : 0)}, ${x}, ${y})`}
                                    >
                                        {node.label}
                                    </text>
                                </g>
                            );
                        })}
                    </svg>
                </div>
            );
        };

        // Render the component
        ReactDOM.createRoot(document.getElementById('visualization-root')).render(<CircularNodesVisualization />);
    </script>
</body>
</html>
